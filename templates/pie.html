{% extends "base.html" %}

{% block title %}Pie Chart{% endblock %}

{% block content %}
<main class="dashboard">
    <h1>Preferred Categories Distribution</h1>

    <div class="chart-section">
        <!-- Pie Chart Container -->
        <div class="chart-box">
            <canvas id="pieChart"></canvas>
        </div>

        <!-- CRUD Panel -->
        <div class="crud-panel">
            <h2>Manage Data</h2>
            <form id="dataForm">
                <input type="hidden" id="editId" value="">
                <input type="text" id="category" placeholder="Category" required>
                <input type="number" id="value" placeholder="Value" required>
                <input type="text" id="username" placeholder="Username" required>
                <input type="text" id="preferredCategory" placeholder="Preferred Category" required>
                <select id="chartType">
                    <option value="pie">Pie</option>
                </select>
                <button type="submit" class="add-btn" id="submitBtn">Add Data</button>
                <button type="button" class="edit-btn" id="updateBtn" style="display: none;">Update Data</button>
            </form>

            <!-- Data Table -->
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Category</th>
                        <th>Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</main>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let pieChart = null;

async function loadChartData() {
    try {
        const response = await fetch('/dept1/api/chart-data/');
        const data = await response.json();
        updateChart(data);
        updateTable(data);
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

function updateChart(data) {
    // Process data for chart
    const categoryCount = {};
    data.forEach(item => {
        const category = item.preferred_category || 'Uncategorized';
        categoryCount[category] = (categoryCount[category] || 0) + 1;
    });

    // Calculate percentages
    const total = Object.values(categoryCount).reduce((a, b) => a + b, 0);
    const categories = Object.keys(categoryCount);
    const values = categories.map(cat => (categoryCount[cat] / total) * 100);

    // Destroy existing chart if it exists
    if (pieChart) {
        pieChart.destroy();
    }

    // Create new chart
    const ctx = document.getElementById('pieChart').getContext('2d');
    pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: categories,
            datasets: [{
                data: values,
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw.toFixed(1);
                            return `${context.label}: ${value}%`;
                        }
                    }
                }
            }
        }
    });
}

function updateTable(data) {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';

    data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.username}</td>
            <td>${item.category}</td>
            <td>${item.value}</td>
            <td>
                <button onclick="editItem(${item.id})" class="edit-btn">Edit</button>
                <button onclick="deleteItem(${item.id})" class="delete-btn">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

async function editItem(id) {
    try {
        const response = await fetch(`/dept1/api/chart-data/`);
        const data = await response.json();
        const item = data.find(item => item.id === id);

        if (item) {
            document.getElementById('editId').value = item.id;
            document.getElementById('username').value = item.username;
            document.getElementById('category').value = item.category;
            document.getElementById('value').value = item.value;
            document.getElementById('preferredCategory').value = item.preferred_category;

            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'block';
        }
    } catch (error) {
        console.error('Error fetching item:', error);
    }
}

async function deleteItem(id) {
    if (confirm('Are you sure you want to delete this item?')) {
        try {
            await fetch(`/dept1/api/chart-data/delete/${id}/`, {
                method: 'DELETE'
            });
            loadChartData();
        } catch (error) {
            console.error('Error deleting item:', error);
        }
    }
}

// Form submission handler
document.getElementById('dataForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
        username: document.getElementById('username').value,
        category: document.getElementById('category').value,
        value: parseInt(document.getElementById('value').value),
        chart_type: document.getElementById('chartType').value,
        preferred_category: document.getElementById('preferredCategory').value
    };

    try {
        await fetch('/dept1/api/chart-data/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        e.target.reset();
        loadChartData();
    } catch (error) {
        console.error('Error adding data:', error);
    }
});

// Update button handler
document.getElementById('updateBtn').addEventListener('click', async () => {
    const id = document.getElementById('editId').value;

    const formData = {
        username: document.getElementById('username').value,
        category: document.getElementById('category').value,
        value: parseInt(document.getElementById('value').value),
        chart_type: document.getElementById('chartType').value,
        preferred_category: document.getElementById('preferredCategory').value
    };

    try {
        await fetch(`/dept1/api/chart-data/update/${id}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        document.getElementById('dataForm').reset();
        document.getElementById('editId').value = '';
        document.getElementById('updateBtn').style.display = 'none';
        document.getElementById('submitBtn').style.display = 'block';

        loadChartData();
    } catch (error) {
        console.error('Error updating data:', error);
    }
});

// Load initial data
loadChartData();
</script>
{% endblock %}